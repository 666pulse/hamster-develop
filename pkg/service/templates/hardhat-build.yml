version: 1.0
name: {{ .Name }}
stages:
  Initialization:
    steps:
      - name: Clone Code from Github
        uses: git-checkout
        with:
          url: {{ .RepositoryUrl }}
          branch: main
  Build Contract:
    needs:
      - Initialization
    steps:
      - name: Compile Contract
        run: |
          npm install
          npm install --save-dev hardhat
          npx hardhat compile
      - name: Filter Info
        run: |
          mkdir -p build/artifacts
          cd artifacts/contracts
          find . -type f -name "*.json" | while read -r file
          do
            echo "处理文件：$file"
            bytecode=$(jq -r '.bytecode' $file)
            length=$(jq '.abi | length' $file)
            if [ "$bytecode" = "0x" ]; then
              echo $file
            elif [ "$length" -eq 0 ]; then
             echo $file
            else
              echo "ok: $file"
              cp -R $file ../../build/artifacts
            fi
          done;

  Output Results:
    needs:
      - Build Contract
    steps:
      - name: Save Files
        uses: hamster-artifactory
        with:
          name: contract-meta.zip
          compress: false
          path: |
            build/artifacts/*.json
